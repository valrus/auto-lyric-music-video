<html>

    <head>
        <meta name="viewport" content="width=800, initial-scale=1" />
        <meta charset="utf-8" />
        <title></title>
        <link rel="profile" href="https://www.w3.org/2005/10/profile" />
        <link rel="icon" type="image/png" href="favicon.png" />
        <link rel="stylesheet" type="text/css" href="static/css/fonts.css" />
    </head>

    <body>
    </body>
    <div id="musicvideo"></div>

    <script type="text/javascript" src="static/js/audio/audio5.min.js"></script>
    <script type="text/javascript" src="static/js/text/opentype.js"></script>

    <script type="text/javascript" src="static/js/elm.js"></script>
    <script type="text/javascript" src="static/js/text.js"></script>

    <script>
    var app = Elm.MusicVideo.fullscreen();

    app.ports.getSizes.subscribe(function (args) {
        opentype.load(args.fontPath, function(err, font) {
            if (err) {
                alert('Could not load font: ' + err);
                app.ports.gotSizes.send(null);
            } else {
                var sizedLyrics = getSizedLyrics(args.lyrics, args.fontName, font);
                app.ports.gotSizes.send(sizedLyrics);
            };
        });
    });

    function initAudio() {
        var audio5js = new Audio5js({
            format_time: false,
            ready: function () {

                //this points to the Audio5js instance

                // This doesn't work; it sends a duration of 0
                /* this.one('canplay', function () {*/
                /* app.ports.canPlay.send(this.duration);*/
                /* }, this);*/

                this.on('play', function () {
                    console.log('play');
                    app.ports.playState.send(true);
                }, this);
                this.on('pause', function () {
                    console.log('pause');
                    app.ports.playState.send(false);
                }, this);
                this.on('ended', function () {
                    console.log('ended');
                    app.ports.playState.send(false);
                }, this);
                this.on('timeupdate', function() {
                    app.ports.playhead.send([this.duration, this.position]);
                }, this);
                this.on('seeked', function() {
                    app.ports.playhead.send([this.duration, this.position]);
                }, this);

                this.load('/static/audio/song.mp3');
                this.play();
            },
        });

        app.ports.togglePlayback.subscribe(function (play) {
            console.log('toggle');
            if (play) {
                audio5js.play();
            }
            else {
                audio5js.pause();
            };
        });

        app.ports.seekTo.subscribe(function (position) {
            audio5js.seek(position);
        });
    }
    initAudio();
    </script>
</html>
