<html>

    <head>
        <meta name="viewport" content="width=800, initial-scale=1" />
        <meta charset="utf-8" />
        <title></title>
        <link rel="profile" href="https://www.w3.org/2005/10/profile" />
        <link rel="icon" type="image/png" href="favicon.png" />
    </head>

    <body>
    </body>
    <div id="musicvideo"></div>

    <script src="static/js/audio/audio5.min.js"></script>
    <script>
    </script>

    <script type="text/javascript" src="static/js/elm.js"></script>
    <script>
     var svgNS = "http://www.w3.org/2000/svg";

     function makeSvgTextElement() {
         var svg = document.createElementNS(svgNS, "svg");
         svg.setAttribute('visibility', 'hidden');
         svg.setAttribute('width', '1024');
         svg.setAttribute('height', '768');
         svg.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:xlink", "http://www.w3.org/1999/xlink");
         document.body.appendChild(svg);
         return svg;
     }

     function getTokenBBox(parentSvg, token) {
         // should probably create text node outside this function and pass in
         var data = document.createTextNode(token);
         var svgElement = document.createElementNS(svgNS, "text");

         svgElement.appendChild(data);
         parentSvg.appendChild(svgElement);
         var bbox = svgElement.getBBox();
         parentSvg.removeChild(svgElement);

         return {
             height: bbox.height,
             width: bbox.width
         };
     }

     function getSizedLyrics(lyrics) {
         var testSvg = makeSvgTextElement();
         var sized_lyrics = [];
         var sized_page = [];
         var this_page = {};
         var this_line = {};
         var this_token = {};
         var page_size = {height: 0, width: 0};
         var line_size = {height: 0, width: 0};
         var token_size = {height: 0, width: 0};
         var x, y;
         for (var page_index = 0; page_index < lyrics.length; page_index++) {
             x = y = page_width = page_height = line_width = line_height = 0;
             sized_page = [];
             this_page = lyrics[page_index];
             page_size = {height: 0, width: 0};
             for (var line_index = 0; line_index < this_page.length; line_index++) {
                 sized_line = [];
                 this_line = this_page[line_index];
                 line_height = line_width = x = 0;
                 for (var token_index = 0; token_index < this_line.length; token_index++) {
                     this_token = this_line[token_index];
                     token_size = getTokenBBox(testSvg, this_token.text)
                     sized_line.push(this_token);
                     line_size.width = line_size.width + token_size.width;
                     line_size.height = Math.max(line_size.height, token_size.height);
                 }
                 sized_page.push({
                     content: sized_line,
                     size: {height: line_size.height, width: line_size.width},
                     pos: {x: x, y: y + line_size.height}
                 });
                 page_size.height = page_size.height + line_size.height;
                 page_size.width = Math.max(page_size.width, line_size.width);
                 y += line_size.height;
             }
             sized_lyrics.push({
                 content: sized_page,
                 size: {height: page_size.height, width: page_size.width}
             });
         }
         return sized_lyrics;
     }

     var app = Elm.MusicVideo.fullscreen();

     app.ports.getSizes.subscribe(function (lyrics) {
         var sizedLyrics = getSizedLyrics(lyrics);
         app.ports.gotSizes.send(sizedLyrics);
     });

     function initAudio() {
         var audio5js = new Audio5js({
             ready: function () {

                 //this points to the Audio5js instance
                 this.on('play', function () {
                     console.log('play');
                     app.ports.playState.send(true);
                 }, this);
                 this.on('pause', function () {
                     console.log('pause');
                     app.ports.playState.send(false);
                 }, this);
                 this.on('ended', function () {
                     console.log('ended');
                     app.ports.playState.send(false);
                 }, this);

                 this.load('/static/audio/song.mp3');
                 this.play();
             },
         });
     }
     initAudio();
    </script>
</html>
