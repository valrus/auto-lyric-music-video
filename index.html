<html>

    <head>
        <meta name="viewport" content="width=800, initial-scale=1" />
        <meta charset="utf-8" />
        <title></title>
        <link rel="profile" href="https://www.w3.org/2005/10/profile" />
        <link rel="icon" type="image/png" href="favicon.png" />
        <link rel="stylesheet" type="text/css" href="static/css/main.css" />
        <link rel="stylesheet" type="text/css" href="static/css/fonts.css" />
    </head>

    <body>
    </body>
    <div id="musicvideo"></div>

    <script type="text/javascript" src="static/js/audio/audio5.min.js"></script>
    <script type="text/javascript" src="static/js/text/opentype.js"></script>

    <script type="text/javascript" src="static/js/elm.js"></script>
    <script type="text/javascript" src="static/js/text.js"></script>

    <script>
    var app = Elm.MusicVideo.fullscreen();
    app.allFonts = {};

    // { lyrics: LyricPage, scratchId: String, fontName: String} -> SizedLyricPage
    app.ports.getSizes.subscribe(function (args) {
        console.log(args);
        console.log(app.allFonts);
        var sizedLyricPage = getSizedLyricPage(args.lyrics, args.scratchId, app.allFonts[args.fontName]);
        app.ports.gotSizes.send(sizedLyricPage);
    });


    function makeSvgTextElement(font) {
        var svg = document.createElementNS(svgNS, "svg");
        var textElement = document.createElementNS(svgNS, "text");
        var data = document.createTextNode("load this font");
        svg.setAttribute('visibility', 'hidden');
        svg.setAttribute('width', '0');
        svg.setAttribute('height', '0');
        svg.setAttribute('font-family', font);
        svg.setAttribute('font-size', '512px');
        svg.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:xlink", "http://www.w3.org/1999/xlink");

        document.body.appendChild(svg);
        svg.appendChild(textElement);
        textElement.appendChild(data);

        return svg;
    }

    // List { name: String, path: String } -> Bool
    app.ports.loadFonts.subscribe(function(fonts) {
        var fontsLoaded = 0;
        var loaderSvgs = {};
        for (var i = 0; i < fonts.length; i++) {
            fontArgs = fonts[i];
            loaderSvgs[fontArgs.name] = makeSvgTextElement(fontArgs.name);
            opentype.load(fontArgs.path, function(err, font) {
                if (err) {
                    alert('Could not load font: ' + err);
                    app.ports.loadedFonts.send(false);
                } else {
                    app.allFonts[fontArgs.name] = font;
                };
                document.body.removeChild(loaderSvgs[fontArgs.name]);
                fontsLoaded++;
                if (fontsLoaded == fonts.length) {
                    console.log(app.allFonts);
                    app.ports.loadedFonts.send(true);
                }
            });
        };
    });

    function initAudio() {
        var audio5js = new Audio5js({
            format_time: false,
            ready: function () {

                //this points to the Audio5js instance

                // This doesn't work; it sends a duration of 0
                /* this.one('canplay', function () {*/
                /* app.ports.canPlay.send(this.duration);*/
                /* }, this);*/

                this.on('play', function () {
                    console.log('play');
                    app.ports.playState.send(true);
                }, this);
                this.on('pause', function () {
                    console.log('pause');
                    app.ports.playState.send(false);
                }, this);
                this.on('ended', function () {
                    console.log('ended');
                    app.ports.playState.send(false);
                }, this);
                this.on('timeupdate', function() {
                    app.ports.playhead.send([this.duration, this.position]);
                }, this);
                this.on('seeked', function() {
                    app.ports.playhead.send([this.duration, this.position]);
                }, this);

                this.load('/static/audio/song.mp3');
            },
        });

        app.ports.togglePlayback.subscribe(function (play) {
            console.log('toggle');
            if (play) {
                audio5js.play();
            }
            else {
                audio5js.pause();
            };
        });

        app.ports.seekTo.subscribe(function (position) {
            audio5js.seek(position);
        });
    }
    initAudio();
    </script>
</html>
